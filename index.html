<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS | Professional Crypto Analysis Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0f1419;
  --bg-secondary: #16181d;
  --bg-elevated: #1c1f26;
  --bg-hover: #22252c;
  --border: #2d3139;
  --text-primary: #e8eaed;
  --text-secondary: #9aa0a6;
  --text-muted: #5f6368;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --purple: #8b5cf6;
  --shadow: 0 2px 8px rgba(0,0,0,0.2);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.3);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, system-ui, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 14px;
  line-height: 1.5;
}

/* HEADER */
.header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
}

.logo-text {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
}

.header-stats {
  display: flex;
  gap: 32px;
  align-items: center;
}

.stat-item {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.stat-value.up { color: var(--green); }
.stat-value.down { color: var(--red); }

.status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: var(--bg-elevated);
  border-radius: 6px;
  border: 1px solid var(--border);
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 2s infinite;
}

.status-dot.loading { background: var(--yellow); }
.status-dot.error { background: var(--red); animation: none; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.status-text {
  font-size: 12px;
  color: var(--text-secondary);
  font-family: 'JetBrains Mono', monospace;
}

/* TOOLBAR */
.toolbar {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--bg-elevated);
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn:hover {
  background: var(--bg-hover);
  border-color: var(--accent);
}

.btn-primary {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover);
}

.btn-success {
  background: var(--green);
  border-color: var(--green);
  color: white;
}

.btn-success:hover {
  background: #059669;
}

.btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

select {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--bg-elevated);
  color: var(--text-primary);
  font-size: 13px;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  outline: none;
}

select:focus {
  border-color: var(--accent);
}

.divider {
  width: 1px;
  height: 24px;
  background: var(--border);
}

/* MAIN LAYOUT */
.container {
  display: flex;
  height: calc(100vh - 120px);
  overflow: hidden;
}

.sidebar {
  width: 360px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-title {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--text-secondary);
  letter-spacing: 0.5px;
}

.coin-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

.coin-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.coin-list::-webkit-scrollbar { width: 6px; }
.coin-list::-webkit-scrollbar-track { background: transparent; }
.coin-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.coin-item {
  display: grid;
  grid-template-columns: 28px 1fr auto;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  margin-bottom: 4px;
  border: 1px solid transparent;
}

.coin-item:hover {
  background: var(--bg-hover);
}

.coin-item.active {
  background: var(--bg-elevated);
  border-color: var(--accent);
}

.coin-rank {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  text-align: center;
}

.coin-info {
  min-width: 0;
}

.coin-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.coin-symbol {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-secondary);
  text-transform: uppercase;
}

.coin-price-block {
  text-align: right;
}

.coin-price {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
}

.coin-change {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
}

.coin-change.up { color: var(--green); }
.coin-change.down { color: var(--red); }

.score-bar {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 4px;
}

.score-fill {
  height: 100%;
  transition: width 0.5s;
  border-radius: 2px;
}

/* MAIN CONTENT */
.main-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px 24px;
}

.main-content::-webkit-scrollbar { width: 6px; }
.main-content::-webkit-scrollbar-track { background: transparent; }
.main-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title-icon {
  font-size: 16px;
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.metric-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  transition: all 0.2s;
}

.metric-card:hover {
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.metric-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.metric-value {
  font-size: 24px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 4px;
}

.metric-value.green { color: var(--green); }
.metric-value.red { color: var(--red); }
.metric-value.blue { color: var(--accent); }
.metric-value.yellow { color: var(--yellow); }

.metric-sub {
  font-size: 12px;
  color: var(--text-secondary);
}

.panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 24px;
}

.chart-container {
  background: var(--bg-elevated);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}

canvas {
  width: 100% !important;
  max-height: 300px;
}

/* TABLE */
.table-wrapper {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid var(--border);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th {
  background: var(--bg-elevated);
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
}

td {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}

tr:last-child td {
  border-bottom: none;
}

tr:hover td {
  background: var(--bg-hover);
}

/* BADGE */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.3px;
}

.badge-buy { background: rgba(16, 185, 129, 0.15); color: var(--green); }
.badge-sell { background: rgba(239, 68, 68, 0.15); color: var(--red); }
.badge-neutral { background: rgba(245, 158, 11, 0.15); color: var(--yellow); }
.badge-strong-buy { background: rgba(16, 185, 129, 0.25); color: var(--green); font-weight: 700; }
.badge-strong-sell { background: rgba(239, 68, 68, 0.25); color: var(--red); font-weight: 700; }

/* PATTERN */
.pattern-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 12px;
}

.pattern-item {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.pattern-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
}

.pattern-signal {
  font-size: 11px;
  font-weight: 600;
}

/* STRATEGY */
.strategy-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.strategy-card {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}

.strategy-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.strategy-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.strategy-score {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 700;
}

.strategy-desc {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 12px;
}

.strategy-detail {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-top: 1px solid var(--border);
  font-size: 12px;
}

.detail-label {
  color: var(--text-secondary);
}

.detail-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  color: var(--text-primary);
}

/* FORMULA */
.formula-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.formula-card {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}

.formula-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 10px;
}

.formula-eq {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  background: var(--bg-primary);
  padding: 12px;
  border-radius: 6px;
  border-left: 3px solid var(--yellow);
  margin-bottom: 10px;
  color: var(--yellow);
  line-height: 1.8;
}

.formula-desc {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 8px;
}

.formula-source {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

.formula-source a {
  color: var(--accent);
  text-decoration: none;
}

.formula-source a:hover {
  text-decoration: underline;
}

/* VERIFICATION */
.verify-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  background: var(--bg-elevated);
}

.verify-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}

.verify-icon.pass { background: rgba(16, 185, 129, 0.15); color: var(--green); }
.verify-icon.fail { background: rgba(239, 68, 68, 0.15); color: var(--red); }

.verify-name {
  flex: 1;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
}

.verify-detail {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

/* LOADING */
.loading {
  position: fixed;
  inset: 0;
  background: rgba(15, 20, 25, 0.9);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
  z-index: 1000;
}

.loading.active {
  display: flex;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 13px;
  color: var(--text-secondary);
}

/* TOAST */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 18px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  color: var(--text-primary);
  box-shadow: var(--shadow-lg);
  transform: translateX(120%);
  transition: transform 0.3s;
  z-index: 2000;
  max-width: 350px;
}

.toast.show {
  transform: translateX(0);
}

.toast.success { border-color: var(--green); }
.toast.error { border-color: var(--red); }

/* TABS */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.tab {
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab:hover {
  color: var(--text-primary);
}

.tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* RESPONSIVE */
@media (max-width: 900px) {
  .container { flex-direction: column; height: auto; }
  .sidebar { width: 100%; max-height: 400px; }
  .header-stats { display: none; }
  .toolbar { justify-content: flex-start; }
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-text {
  font-size: 14px;
  color: var(--text-secondary);
}

/* SCORE RING */
.score-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.score-ring {
  position: relative;
  width: 140px;
  height: 140px;
}

.score-ring svg {
  transform: rotate(-90deg);
  width: 140px;
  height: 140px;
}

.score-ring circle {
  fill: none;
  stroke-width: 10;
}

.score-bg { stroke: var(--border); }
.score-val { stroke-dasharray: 439.6; transition: stroke-dashoffset 1s; }

.score-center {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.score-number {
  font-size: 36px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
}

.score-label {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
}

.score-breakdown {
  flex: 1;
  min-width: 280px;
}

.score-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.score-row-label {
  width: 140px;
  font-size: 12px;
  color: var(--text-secondary);
}

.score-row-bar {
  flex: 1;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}

.score-row-fill {
  height: 100%;
  transition: width 0.6s;
  border-radius: 3px;
}

.score-row-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  min-width: 30px;
  text-align: right;
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Loading...</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">N</div>
    <div>
      <div class="logo-text">NEXUS</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:-2px;">Professional Crypto Analysis</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="stat-item">
      <div class="stat-label">Market Cap</div>
      <div class="stat-value" id="globalMcap">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">24h Volume</div>
      <div class="stat-value" id="globalVol">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">BTC Dom</div>
      <div class="stat-value" id="btcDom">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Fear & Greed</div>
      <div class="stat-value" id="fearGreed">‚Äî</div>
    </div>
  </div>
  <div class="status">
    <div class="status-dot" id="statusDot"></div>
    <div class="status-text" id="statusText">Ready</div>
  </div>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <button class="btn btn-success" onclick="refreshData()">
    <span>‚Üª</span> Refresh Data
  </button>
  <button class="btn" onclick="toggleAuto()" id="autoBtn">
    <span>‚è±</span> Auto: OFF
  </button>
  <div class="divider"></div>
  <select id="topN" onchange="handleTopNChange()">
    <option value="15">Top 15</option>
    <option value="25">Top 25</option>
    <option value="50">Top 50</option>
  </select>
  <select id="analysisMode" onchange="handleModeChange()">
    <option value="balanced">Balanced Analysis</option>
    <option value="momentum">Momentum Focus</option>
    <option value="value">Value Focus</option>
    <option value="volatility">Volatility Focus</option>
  </select>
  <div class="divider"></div>
  <button class="btn" onclick="verifyCalcs()">
    <span>‚úì</span> Verify
  </button>
  <button class="btn" onclick="exportJSON()">
    <span>‚¨á</span> Export JSON
  </button>
</div>

<!-- MAIN CONTAINER -->
<div class="container">
  
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">üéØ Opportunity Scanner</div>
      <div class="coin-count" id="coinCount">0 coins</div>
    </div>
    <div class="coin-list" id="coinList">
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <div class="empty-text">Click "Refresh Data" to load coins</div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    
    <div class="tabs">
      <div class="tab active" data-tab="overview" onclick="switchTab('overview')">üìà Overview</div>
      <div class="tab" data-tab="signals" onclick="switchTab('signals')">üìä Signals</div>
      <div class="tab" data-tab="patterns" onclick="switchTab('patterns')">üïØ Candlesticks</div>
      <div class="tab" data-tab="strategies" onclick="switchTab('strategies')">‚ö° Strategies</div>
      <div class="tab" data-tab="formulas" onclick="switchTab('formulas')">‚àë Formulas</div>
      <div class="tab" data-tab="verify" onclick="switchTab('verify')">‚úì Verification</div>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="overview">
      
      <div class="panel" id="scorePanel">
        <div class="section-title">
          <span class="section-title-icon">üéØ</span>
          Composite Opportunity Score
        </div>
        <div class="score-display">
          <div class="score-ring">
            <svg viewBox="0 0 140 140">
              <circle class="score-bg" cx="70" cy="70" r="65"/>
              <circle class="score-val" id="scoreCircle" cx="70" cy="70" r="65" stroke-dashoffset="439.6"/>
            </svg>
            <div class="score-center">
              <div class="score-number" id="scoreNum" style="color:var(--accent)">‚Äî</div>
              <div class="score-label">/ 100</div>
            </div>
          </div>
          <div class="score-breakdown" id="scoreBreakdown">
            <div style="color:var(--text-muted);font-size:13px;">Select a coin to see detailed analysis</div>
          </div>
        </div>
      </div>

      <div class="section-title">
        <span class="section-title-icon">üìä</span>
        Key Metrics
      </div>
      <div class="card-grid" id="metricsGrid">
        <div class="metric-card">
          <div class="metric-label">Current Price</div>
          <div class="metric-value blue" id="metricPrice">‚Äî</div>
          <div class="metric-sub">USD</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">24h Change</div>
          <div class="metric-value" id="metricChange">‚Äî</div>
          <div class="metric-sub" id="metricChangeSub">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Market Cap</div>
          <div class="metric-value yellow" id="metricMcap">‚Äî</div>
          <div class="metric-sub" id="metricMcapSub">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">24h Volume</div>
          <div class="metric-value" id="metricVol">‚Äî</div>
          <div class="metric-sub" id="metricVolSub">‚Äî</div>
        </div>
      </div>

      <div class="section-title">
        <span class="section-title-icon">üìâ</span>
        Price Chart (7D)
      </div>
      <div class="chart-container">
        <canvas id="priceChart" height="220"></canvas>
      </div>

      <div class="section-title">
        <span class="section-title-icon">üèÜ</span>
        Top Opportunities
      </div>
      <div class="panel">
        <div class="table-wrapper">
          <table id="oppTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Asset</th>
                <th>Price</th>
                <th>Score</th>
                <th>24h %</th>
                <th>RSI</th>
                <th>MACD</th>
                <th>Signal</th>
              </tr>
            </thead>
            <tbody id="oppBody">
              <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);">Load data to see opportunities</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- SIGNALS TAB -->
    <div class="tab-content" id="signals">
      <div class="section-title">
        <span class="section-title-icon">üìä</span>
        Technical Indicators
      </div>
      <div class="panel">
        <div class="strategy-grid" id="signalsGrid">
          <div style="color:var(--text-muted);padding:20px;">Select a coin to view signals</div>
        </div>
      </div>
    </div>

    <!-- PATTERNS TAB -->
    <div class="tab-content" id="patterns">
      <div class="section-title">
        <span class="section-title-icon">üïØ</span>
        Japanese Candlestick Patterns
      </div>
      <div class="panel">
        <div class="pattern-list" id="patternsList">
          <div style="color:var(--text-muted);padding:20px;">Select a coin to detect patterns</div>
        </div>
      </div>
    </div>

    <!-- STRATEGIES TAB -->
    <div class="tab-content" id="strategies">
      <div class="section-title">
        <span class="section-title-icon">‚ö°</span>
        Trading Strategy Analysis
      </div>
      <div class="strategy-grid" id="strategyGrid">
        <div style="color:var(--text-muted);padding:20px;">Select a coin to analyze strategies</div>
      </div>
    </div>

    <!-- FORMULAS TAB -->
    <div class="tab-content" id="formulas">
      <div class="section-title">
        <span class="section-title-icon">‚àë</span>
        Formulas & Sources
      </div>
      <div class="formula-list" id="formulasList">
        <!-- Formulas will be populated -->
      </div>
    </div>

    <!-- VERIFY TAB -->
    <div class="tab-content" id="verify">
      <div class="section-title">
        <span class="section-title-icon">‚úì</span>
        Calculation Verification
      </div>
      <div class="panel" id="verifyPanel">
        <div style="color:var(--text-muted);">Click "Verify" button to run checks</div>
      </div>
    </div>

  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEXUS CRYPTO ANALYSIS PLATFORM V2
// Professional Edition with Candlestick Patterns & Trading Strategies
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const API = 'https://api.coingecko.com/api/v3';
const RATE_LIMIT_DELAY = 2500; // 2.5s between requests (safe for free tier)

let globalData = null;
let coinsData = [];
let selectedCoin = null;
let ohlcData = {};
let autoRefreshTimer = null;
let lastRequestTime = 0;

// STABLECOINS TO EXCLUDE
const STABLECOINS = ['tether', 'usd-coin', 'binance-usd', 'dai', 'true-usd', 'paxos-standard', 
                     'gemini-dollar', 'frax', 'usdd', 'neutrino', 'fei-usd', 'terrausd'];

// ‚îÄ‚îÄ‚îÄ RATE LIMITING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rateLimitedFetch(url, retries = 3) {
  const now = Date.now();
  const elapsed = now - lastRequestTime;
  if (elapsed < RATE_LIMIT_DELAY) {
    await new Promise(r => setTimeout(r, RATE_LIMIT_DELAY - elapsed));
  }
  
  for (let i = 0; i < retries; i++) {
    try {
      lastRequestTime = Date.now();
      const res = await fetch(url);
      if (res.status === 429) {
        const wait = Math.min(5000 * (i + 1), 20000);
        console.warn(`Rate limited, waiting ${wait}ms`);
        await new Promise(r => setTimeout(r, wait));
        continue;
      }
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (e) {
      if (i === retries - 1) throw e;
      await new Promise(r => setTimeout(r, 2000 * (i + 1)));
    }
  }
}

// ‚îÄ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoading(text = 'Loading...') {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loading').classList.add('active');
}

function hideLoading() {
  document.getElementById('loading').classList.remove('active');
}

function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast show ${type}`;
  setTimeout(() => el.classList.remove('show'), 3000);
}

function setStatus(state, text) {
  const dot = document.getElementById('statusDot');
  const txt = document.getElementById('statusText');
  dot.className = `status-dot ${state}`;
  txt.textContent = text;
}

function formatUSD(n) {
  if (!n && n !== 0) return '‚Äî';
  if (n >= 1e12) return '$' + (n / 1e12).toFixed(2) + 'T';
  if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
  if (n >= 1000) return '$' + n.toLocaleString(undefined, {maximumFractionDigits: 2});
  if (n >= 1) return '$' + n.toFixed(4);
  return '$' + n.toFixed(8);
}

function formatPct(n) {
  if (n === null || n === undefined) return '‚Äî';
  return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
}

// ‚îÄ‚îÄ‚îÄ DATA FETCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshData() {
  showLoading('Fetching market data...');
  setStatus('loading', 'Loading');
  
  try {
    // Global data
    showLoading('Loading global stats...');
    const global = await rateLimitedFetch(`${API}/global`);
    globalData = global.data;
    updateGlobalStats();
    
    // Coins data
    const topN = parseInt(document.getElementById('topN').value);
    showLoading(`Loading top ${topN} coins...`);
    const coins = await rateLimitedFetch(
      `${API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${topN * 2}&page=1&sparkline=false&price_change_percentage=24h,7d`
    );
    
    // Filter out stablecoins
    coinsData = coins.filter(c => !STABLECOINS.includes(c.id)).slice(0, topN);
    
    renderCoinList();
    
    // Fear & Greed
    try {
      const fng = await rateLimitedFetch('https://api.alternative.me/fng/?limit=1');
      document.getElementById('fearGreed').textContent = fng.data[0].value;
      document.getElementById('fearGreed').className = 
        fng.data[0].value > 60 ? 'stat-value up' : fng.data[0].value < 40 ? 'stat-value down' : 'stat-value';
    } catch { 
      document.getElementById('fearGreed').textContent = 'N/A';
    }
    
    // If coin was selected, reload it
    if (selectedCoin) {
      const coin = coinsData.find(c => c.id === selectedCoin.id);
      if (coin) await selectCoin(coin.id);
    }
    
    updateOpportunityTable();
    setStatus('', 'Live');
    toast('Data refreshed successfully', 'success');
  } catch (e) {
    setStatus('error', 'Error');
    toast('API Error: ' + e.message, 'error');
    console.error(e);
  } finally {
    hideLoading();
  }
}

function updateGlobalStats() {
  if (!globalData) return;
  document.getElementById('globalMcap').textContent = formatUSD(globalData.total_market_cap?.usd);
  document.getElementById('globalVol').textContent = formatUSD(globalData.total_volume?.usd);
  document.getElementById('btcDom').textContent = globalData.market_cap_percentage?.btc?.toFixed(1) + '%';
}

// ‚îÄ‚îÄ‚îÄ COIN LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCoinList() {
  const list = document.getElementById('coinList');
  document.getElementById('coinCount').textContent = `${coinsData.length} coins`;
  
  const sorted = [...coinsData].map(c => ({ c, score: computeScore(c).total }))
    .sort((a, b) => b.score - a.score);
  
  list.innerHTML = sorted.map(({ c, score }, i) => {
    const change = c.price_change_percentage_24h || 0;
    const color = score >= 70 ? 'var(--green)' : score >= 50 ? 'var(--yellow)' : 'var(--red)';
    return `
      <div class="coin-item ${selectedCoin?.id === c.id ? 'active' : ''}" onclick="selectCoin('${c.id}')">
        <div class="coin-rank">${i + 1}</div>
        <div class="coin-info">
          <div class="coin-name">${c.name}</div>
          <div class="coin-symbol">${c.symbol}</div>
          <div class="score-bar">
            <div class="score-fill" style="width:${score}%;background:${color}"></div>
          </div>
        </div>
        <div class="coin-price-block">
          <div class="coin-price">${formatUSD(c.current_price)}</div>
          <div class="coin-change ${change >= 0 ? 'up' : 'down'}">${formatPct(change)}</div>
        </div>
      </div>`;
  }).join('');
}

async function selectCoin(id) {
  const coin = coinsData.find(c => c.id === id);
  if (!coin) return;
  selectedCoin = coin;
  
  showLoading(`Loading ${coin.symbol.toUpperCase()} data...`);
  try {
    await loadOHLC(id);
    renderOverview(coin);
    renderSignals(coin);
    renderPatterns(coin);
    renderStrategies(coin);
    updateOpportunityTable();
    toast(`${coin.symbol.toUpperCase()} loaded`, 'success');
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  } finally {
    hideLoading();
  }
  
  renderCoinList(); // Re-render to show active state
}

async function loadOHLC(id) {
  try {
    const data = await rateLimitedFetch(`${API}/coins/${id}/ohlc?vs_currency=usd&days=7`);
    ohlcData[id] = data;
  } catch (e) {
    console.warn('OHLC failed:', e);
    ohlcData[id] = [];
  }
}

// ‚îÄ‚îÄ‚îÄ CALCULATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// EMA
function calcEMA(prices, period) {
  if (prices.length < period) return [];
  const k = 2 / (period + 1);
  const ema = [prices.slice(0, period).reduce((a, b) => a + b) / period];
  for (let i = period; i < prices.length; i++) {
    ema.push(prices[i] * k + ema[ema.length - 1] * (1 - k));
  }
  return ema;
}

// RSI - Source: J. Welles Wilder Jr. (1978)
function calcRSI(closes, period = 14) {
  if (closes.length < period + 1) return null;
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = closes[i] - closes[i - 1];
    if (diff >= 0) gains += diff; else losses -= diff;
  }
  let avgGain = gains / period, avgLoss = losses / period;
  for (let i = period + 1; i < closes.length; i++) {
    const diff = closes[i] - closes[i - 1];
    avgGain = (avgGain * (period - 1) + Math.max(diff, 0)) / period;
    avgLoss = (avgLoss * (period - 1) + Math.max(-diff, 0)) / period;
  }
  if (avgLoss === 0) return 100;
  return 100 - 100 / (1 + avgGain / avgLoss);
}

// MACD - Source: Gerald Appel (1979)
function calcMACD(closes) {
  if (closes.length < 26) return null;
  const ema12 = calcEMA(closes, 12);
  const ema26 = calcEMA(closes, 26);
  const offset = ema12.length - ema26.length;
  const macd = ema26.map((v, i) => ema12[i + offset] - v);
  const signal = calcEMA(macd, 9);
  const histogram = signal.map((v, i) => macd[i + macd.length - signal.length] - v);
  return {
    macd: macd[macd.length - 1],
    signal: signal[signal.length - 1],
    histogram: histogram[histogram.length - 1]
  };
}

// Bollinger Bands - Source: John Bollinger (2002)
function calcBB(closes, period = 20, mult = 2) {
  if (closes.length < period) return null;
  const slice = closes.slice(-period);
  const mean = slice.reduce((a, b) => a + b) / period;
  const variance = slice.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / period;
  const stdDev = Math.sqrt(variance);
  const upper = mean + mult * stdDev;
  const lower = mean - mult * stdDev;
  const price = closes[closes.length - 1];
  const pctB = upper !== lower ? (price - lower) / (upper - lower) : 0.5;
  return { upper, middle: mean, lower, pctB };
}

// ‚îÄ‚îÄ‚îÄ JAPANESE CANDLESTICK PATTERNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sources: Munehisa Homma (17th century), Steve Nison (1991)

function detectCandlestickPatterns(ohlc) {
  if (!ohlc || ohlc.length < 3) return [];
  
  const patterns = [];
  const n = ohlc.length;
  
  // Last 3 candles
  const c1 = ohlc[n - 3];
  const c2 = ohlc[n - 2];
  const c3 = ohlc[n - 1];
  
  const [t1, o1, h1, l1, cl1] = c1;
  const [t2, o2, h2, l2, cl2] = c2;
  const [t3, o3, h3, l3, cl3] = c3;
  
  const body1 = Math.abs(cl1 - o1);
  const body2 = Math.abs(cl2 - o2);
  const body3 = Math.abs(cl3 - o3);
  
  const upperWick3 = h3 - Math.max(o3, cl3);
  const lowerWick3 = Math.min(o3, cl3) - l3;
  
  // DOJI - Source: Japanese Candlestick Charting Techniques (Nison, 1991)
  if (body3 < (h3 - l3) * 0.1) {
    patterns.push({ name: 'Doji', signal: 'NEUTRAL', desc: 'Indecision - potential reversal' });
  }
  
  // HAMMER - Bullish reversal
  if (lowerWick3 > body3 * 2 && upperWick3 < body3 * 0.5 && cl3 > o3) {
    patterns.push({ name: 'Hammer', signal: 'BUY', desc: 'Bullish reversal signal' });
  }
  
  // SHOOTING STAR - Bearish reversal
  if (upperWick3 > body3 * 2 && lowerWick3 < body3 * 0.5 && cl3 < o3) {
    patterns.push({ name: 'Shooting Star', signal: 'SELL', desc: 'Bearish reversal signal' });
  }
  
  // ENGULFING PATTERNS
  if (cl1 < o1 && cl3 > o3 && cl3 > o1 && o3 < cl1) {
    patterns.push({ name: 'Bullish Engulfing', signal: 'STRONG BUY', desc: 'Strong bullish reversal' });
  }
  if (cl1 > o1 && cl3 < o3 && cl3 < o1 && o3 > cl1) {
    patterns.push({ name: 'Bearish Engulfing', signal: 'STRONG SELL', desc: 'Strong bearish reversal' });
  }
  
  // MORNING STAR (3-candle bullish)
  if (cl1 < o1 && body2 < body1 * 0.3 && cl3 > o3 && cl3 > (o1 + cl1) / 2) {
    patterns.push({ name: 'Morning Star', signal: 'STRONG BUY', desc: '3-candle bullish reversal' });
  }
  
  // EVENING STAR (3-candle bearish)
  if (cl1 > o1 && body2 < body1 * 0.3 && cl3 < o3 && cl3 < (o1 + cl1) / 2) {
    patterns.push({ name: 'Evening Star', signal: 'STRONG SELL', desc: '3-candle bearish reversal' });
  }
  
  // MARUBOZU - Strong directional candle with no wicks
  if (upperWick3 < (h3 - l3) * 0.05 && lowerWick3 < (h3 - l3) * 0.05) {
    if (cl3 > o3) {
      patterns.push({ name: 'Bullish Marubozu', signal: 'BUY', desc: 'Strong buying pressure' });
    } else {
      patterns.push({ name: 'Bearish Marubozu', signal: 'SELL', desc: 'Strong selling pressure' });
    }
  }
  
  // HARAMI
  if (body1 > body3 && Math.max(o3, cl3) < Math.max(o1, cl1) && Math.min(o3, cl3) > Math.min(o1, cl1)) {
    if (cl1 < o1 && cl3 > o3) {
      patterns.push({ name: 'Bullish Harami', signal: 'BUY', desc: 'Potential trend reversal up' });
    } else if (cl1 > o1 && cl3 < o3) {
      patterns.push({ name: 'Bearish Harami', signal: 'SELL', desc: 'Potential trend reversal down' });
    }
  }
  
  return patterns;
}

// ‚îÄ‚îÄ‚îÄ TRADING STRATEGIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// MOMENTUM STRATEGY - Source: Briplotnik (2025), Medium
function calcMomentumStrategy(closes, coin) {
  if (closes.length < 30) return null;
  
  // Z-score momentum
  const shortWindow = closes.slice(-5);
  const longWindow = closes.slice(-20);
  const shortMean = shortWindow.reduce((a, b) => a + b) / shortWindow.length;
  const longMean = longWindow.reduce((a, b) => a + b) / longWindow.length;
  const longStd = Math.sqrt(longWindow.reduce((s, v) => s + Math.pow(v - longMean, 2), 0) / longWindow.length);
  const zScore = longStd > 0 ? (shortMean - longMean) / longStd : 0;
  
  const signal = zScore > 1.5 ? 'STRONG BUY' : zScore > 0.5 ? 'BUY' : zScore < -1.5 ? 'STRONG SELL' : zScore < -0.5 ? 'SELL' : 'NEUTRAL';
  const score = Math.min(Math.max((zScore + 3) / 6 * 100, 0), 100);
  
  return {
    name: 'Momentum (Z-Score)',
    score: Math.round(score),
    signal,
    zScore: zScore.toFixed(2),
    desc: 'Compares short-term vs long-term returns. Z-score > 1.5 indicates strong momentum.'
  };
}

// MEAN REVERSION STRATEGY - Source: UEEx Technology (2024), Stoic.ai (2025)
function calcMeanReversionStrategy(closes, coin) {
  if (closes.length < 30) return null;
  
  const sma = closes.slice(-30).reduce((a, b) => a + b) / 30;
  const current = closes[closes.length - 1];
  const deviation = ((current - sma) / sma) * 100;
  
  // RSI for overbought/oversold
  const rsi = calcRSI(closes);
  
  let signal = 'NEUTRAL';
  if (deviation < -10 && rsi < 30) signal = 'STRONG BUY';
  else if (deviation < -5 && rsi < 40) signal = 'BUY';
  else if (deviation > 10 && rsi > 70) signal = 'STRONG SELL';
  else if (deviation > 5 && rsi > 60) signal = 'SELL';
  
  const score = Math.min(Math.max(50 - deviation * 2, 0), 100);
  
  return {
    name: 'Mean Reversion',
    score: Math.round(score),
    signal,
    deviation: deviation.toFixed(2) + '%',
    rsi: rsi?.toFixed(0) || 'N/A',
    desc: 'Expects prices to return to 30-day average. Strong signals when >10% deviation + extreme RSI.'
  };
}

// BREAKOUT STRATEGY - Source: Kraken Learn (2025), Efe Arda SSRN (2025)
function calcBreakoutStrategy(ohlc, coin) {
  if (!ohlc || ohlc.length < 20) return null;
  
  const bb = calcBB(ohlc.map(d => d[4]));
  if (!bb) return null;
  
  const current = ohlc[ohlc.length - 1][4];
  const volume = coin.total_volume;
  const avgVol = coin.total_volume; // Proxy
  
  let signal = 'NEUTRAL';
  let score = 50;
  
  // Breakout above upper band
  if (current > bb.upper) {
    signal = volume > avgVol * 1.5 ? 'STRONG BUY' : 'BUY';
    score = 75;
  }
  // Breakout below lower band
  else if (current < bb.lower) {
    signal = volume > avgVol * 1.5 ? 'STRONG SELL' : 'SELL';
    score = 25;
  }
  // Inside bands
  else {
    score = 50 + (bb.pctB - 0.5) * 50;
  }
  
  return {
    name: 'Breakout (Bollinger)',
    score: Math.round(score),
    signal,
    bbPos: (bb.pctB * 100).toFixed(1) + '%',
    desc: 'Trades breakouts above/below Bollinger Bands with volume confirmation.'
  };
}

// TREND FOLLOWING - Source: QuantPedia (2023, 2025)
function calcTrendFollowingStrategy(closes) {
  if (closes.length < 50) return null;
  
  const sma20 = closes.slice(-20).reduce((a, b) => a + b) / 20;
  const sma50 = closes.slice(-50).reduce((a, b) => a + b) / 50;
  const current = closes[closes.length - 1];
  
  let signal = 'NEUTRAL';
  let score = 50;
  
  if (current > sma20 && sma20 > sma50) {
    signal = 'STRONG BUY';
    score = 80;
  } else if (current > sma20) {
    signal = 'BUY';
    score = 65;
  } else if (current < sma20 && sma20 < sma50) {
    signal = 'STRONG SELL';
    score = 20;
  } else if (current < sma20) {
    signal = 'SELL';
    score = 35;
  }
  
  return {
    name: 'Trend Following (SMA)',
    score,
    signal,
    sma20: sma20.toFixed(2),
    sma50: sma50.toFixed(2),
    desc: 'Follows trend using SMA crossovers. Price > SMA20 > SMA50 = strong uptrend.'
  };
}

// ‚îÄ‚îÄ‚îÄ COMPOSITE SCORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeScore(coin, ohlc = null) {
  const closes = ohlc ? ohlc.map(d => d[4]) : null;
  
  let rsiScore = 50, macdScore = 50, bbScore = 50, volScore = 50, rocScore = 50, mcapScore = 50;
  
  // RSI
  if (closes && closes.length >= 15) {
    const rsi = calcRSI(closes);
    if (rsi !== null) {
      if (rsi < 30) rsiScore = 80;
      else if (rsi < 40) rsiScore = 70;
      else if (rsi <= 60) rsiScore = 60;
      else if (rsi <= 70) rsiScore = 45;
      else rsiScore = 20;
    }
  } else {
    const ch = coin.price_change_percentage_24h || 0;
    rsiScore = 50 + Math.min(Math.max(ch * 2, -40), 40);
  }
  
  // MACD
  if (closes && closes.length >= 27) {
    const macd = calcMACD(closes);
    if (macd) {
      if (macd.histogram > 0 && macd.macd > macd.signal) macdScore = 80;
      else if (macd.histogram > 0) macdScore = 65;
      else if (macd.histogram < 0 && macd.macd > 0) macdScore = 45;
      else macdScore = 25;
    }
  }
  
  // Bollinger
  if (closes && closes.length >= 20) {
    const bb = calcBB(closes);
    if (bb) {
      if (bb.pctB < 0) bbScore = 85;
      else if (bb.pctB < 0.2) bbScore = 75;
      else if (bb.pctB < 0.5) bbScore = 60;
      else if (bb.pctB < 0.8) bbScore = 50;
      else if (bb.pctB < 1) bbScore = 35;
      else bbScore = 15;
    }
  }
  
  // Volume
  const vmRatio = coin.total_volume && coin.market_cap ? coin.total_volume / coin.market_cap : 0;
  volScore = Math.min((vmRatio / 0.5) * 100, 100);
  
  // ROC
  if (closes && closes.length >= 11) {
    const curr = closes[closes.length - 1];
    const prev = closes[closes.length - 11];
    const roc = ((curr - prev) / prev) * 100;
    if (roc > 10) rocScore = 80;
    else if (roc > 3) rocScore = 65;
    else if (roc > -3) rocScore = 50;
    else if (roc > -10) rocScore = 35;
    else rocScore = 15;
  }
  
  // Market cap
  const rank = coin.market_cap_rank || 999;
  if (rank <= 5) mcapScore = 40;
  else if (rank <= 15) mcapScore = 55;
  else if (rank <= 30) mcapScore = 65;
  else if (rank <= 50) mcapScore = 70;
  else mcapScore = 75;
  
  // Mode weights
  const mode = document.getElementById('analysisMode').value;
  let w = { rsi: 0.25, macd: 0.20, bb: 0.20, vol: 0.15, roc: 0.10, mcap: 0.10 };
  if (mode === 'momentum') w = { rsi: 0.15, macd: 0.30, bb: 0.10, vol: 0.10, roc: 0.25, mcap: 0.10 };
  if (mode === 'value') w = { rsi: 0.30, macd: 0.15, bb: 0.25, vol: 0.10, roc: 0.05, mcap: 0.15 };
  if (mode === 'volatility') w = { rsi: 0.20, macd: 0.15, bb: 0.30, vol: 0.20, roc: 0.10, mcap: 0.05 };
  
  const total = Math.round(
    rsiScore * w.rsi + macdScore * w.macd + bbScore * w.bb +
    volScore * w.vol + rocScore * w.roc + mcapScore * w.mcap
  );
  
  return { total, rsiScore, macdScore, bbScore, volScore, rocScore, mcapScore };
}

// ‚îÄ‚îÄ‚îÄ RENDER OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverview(coin) {
  const ohlc = ohlcData[coin.id] || [];
  const closes = ohlc.map(d => d[4]).filter(Boolean);
  const score = computeScore(coin, ohlc.length ? ohlc : null);
  
  // Score ring
  const pct = score.total / 100;
  const circumference = 439.6;
  const offset = circumference - pct * circumference;
  document.getElementById('scoreCircle').style.strokeDashoffset = offset;
  const color = score.total >= 70 ? 'var(--green)' : score.total >= 50 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('scoreCircle').style.stroke = color;
  document.getElementById('scoreNum').textContent = score.total;
  document.getElementById('scoreNum').style.color = color;
  
  // Breakdown
  const breakdown = [
    ['RSI (25%)', score.rsiScore, 'var(--accent)'],
    ['MACD (20%)', score.macdScore, 'var(--purple)'],
    ['Bollinger (20%)', score.bbScore, 'var(--green)'],
    ['Volume (15%)', score.volScore, 'var(--yellow)'],
    ['ROC (10%)', score.rocScore, '#ff6b35'],
    ['Market Cap (10%)', score.mcapScore, 'var(--red)']
  ];
  
  document.getElementById('scoreBreakdown').innerHTML = breakdown.map(([label, val, color]) => `
    <div class="score-row">
      <div class="score-row-label">${label}</div>
      <div class="score-row-bar">
        <div class="score-row-fill" style="width:${val}%;background:${color}"></div>
      </div>
      <div class="score-row-value">${val}</div>
    </div>`).join('');
  
  // Metrics
  const change = coin.price_change_percentage_24h || 0;
  document.getElementById('metricPrice').textContent = formatUSD(coin.current_price);
  document.getElementById('metricChange').textContent = formatPct(change);
  document.getElementById('metricChange').className = `metric-value ${change >= 0 ? 'green' : 'red'}`;
  document.getElementById('metricChangeSub').textContent = change >= 0 ? '‚ñ≤ Bullish' : '‚ñº Bearish';
  document.getElementById('metricMcap').textContent = formatUSD(coin.market_cap);
  document.getElementById('metricMcapSub').textContent = `Rank #${coin.market_cap_rank || '‚Äî'}`;
  document.getElementById('metricVol').textContent = formatUSD(coin.total_volume);
  const vmRatio = coin.total_volume && coin.market_cap ? (coin.total_volume / coin.market_cap * 100).toFixed(2) : '‚Äî';
  document.getElementById('metricVolSub').textContent = `${vmRatio}% of MCap`;
  
  // Chart
  drawChart(coin, ohlc);
}

function drawChart(coin, ohlc) {
  const canvas = document.getElementById('priceChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth || 800;
  canvas.height = 220;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (!ohlc || ohlc.length === 0) {
    ctx.fillStyle = 'var(--text-muted)';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('No chart data available', canvas.width / 2, canvas.height / 2);
    return;
  }
  
  const W = canvas.width, H = canvas.height;
  const pad = { top: 20, right: 20, bottom: 30, left: 60 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;
  
  const highs = ohlc.map(d => d[2]);
  const lows = ohlc.map(d => d[3]);
  const minP = Math.min(...lows) * 0.998;
  const maxP = Math.max(...highs) * 1.002;
  const range = maxP - minP;
  
  const toX = (i) => pad.left + (i / (ohlc.length - 1)) * chartW;
  const toY = (p) => pad.top + chartH - ((p - minP) / range) * chartH;
  
  // Grid
  ctx.strokeStyle = 'rgba(45, 49, 57, 0.5)';
  ctx.lineWidth = 1;
  for (let g = 0; g <= 4; g++) {
    const y = pad.top + (g / 4) * chartH;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(W - pad.right, y);
    ctx.stroke();
    
    const price = maxP - (g / 4) * range;
    ctx.fillStyle = 'var(--text-muted)';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText(formatUSD(price), pad.left - 5, y + 3);
  }
  
  // Candles
  const candleW = Math.max(Math.min((chartW / ohlc.length) * 0.7, 12), 2);
  ohlc.forEach((d, i) => {
    const [ts, open, high, low, close] = d;
    const x = toX(i);
    const isGreen = close >= open;
    const color = isGreen ? 'var(--green)' : 'var(--red)';
    
    // Wick
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x, toY(high));
    ctx.lineTo(x, toY(low));
    ctx.stroke();
    
    // Body
    const bodyTop = toY(Math.max(open, close));
    const bodyH = Math.max(Math.abs(toY(open) - toY(close)), 1);
    ctx.fillStyle = isGreen ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
    ctx.fillRect(x - candleW / 2, bodyTop, candleW, bodyH);
  });
  
  // Label
  ctx.fillStyle = 'var(--text-primary)';
  ctx.font = '600 12px Inter';
  ctx.textAlign = 'left';
  ctx.fillText(`${coin.symbol.toUpperCase()} ¬∑ 7D OHLC`, pad.left, pad.top - 5);
}

// ‚îÄ‚îÄ‚îÄ RENDER SIGNALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSignals(coin) {
  const ohlc = ohlcData[coin.id] || [];
  const closes = ohlc.map(d => d[4]).filter(Boolean);
  
  const rsi = closes.length >= 15 ? calcRSI(closes) : null;
  const macd = closes.length >= 27 ? calcMACD(closes) : null;
  const bb = closes.length >= 20 ? calcBB(closes) : null;
  
  const indicators = [];
  
  const rsiSig = rsi === null ? 'NEUTRAL' : rsi < 30 ? 'STRONG BUY' : rsi < 45 ? 'BUY' : rsi > 70 ? 'STRONG SELL' : rsi > 55 ? 'SELL' : 'NEUTRAL';
  indicators.push({
    label: 'RSI (14)',
    value: rsi !== null ? rsi.toFixed(1) : 'N/A',
    signal: rsiSig
  });
  
  const macdSig = !macd ? 'NEUTRAL' : macd.histogram > 0 ? 'BUY' : 'SELL';
  indicators.push({
    label: 'MACD',
    value: macd ? macd.histogram.toFixed(2) : 'N/A',
    signal: macdSig
  });
  
  const bbSig = !bb ? 'NEUTRAL' : bb.pctB < 0 ? 'STRONG BUY' : bb.pctB < 0.2 ? 'BUY' : bb.pctB > 1 ? 'STRONG SELL' : bb.pctB > 0.8 ? 'SELL' : 'NEUTRAL';
  indicators.push({
    label: 'Bollinger %B',
    value: bb ? (bb.pctB * 100).toFixed(1) + '%' : 'N/A',
    signal: bbSig
  });
  
  const change24 = coin.price_change_percentage_24h || 0;
  const momSig = change24 > 5 ? 'STRONG BUY' : change24 > 2 ? 'BUY' : change24 < -5 ? 'STRONG SELL' : change24 < -2 ? 'SELL' : 'NEUTRAL';
  indicators.push({
    label: '24H Momentum',
    value: formatPct(change24),
    signal: momSig
  });
  
  const sigClass = {
    'STRONG BUY': 'badge-strong-buy',
    'BUY': 'badge-buy',
    'SELL': 'badge-sell',
    'STRONG SELL': 'badge-strong-sell',
    'NEUTRAL': 'badge-neutral'
  };
  
  document.getElementById('signalsGrid').innerHTML = indicators.map(ind => `
    <div class="strategy-card">
      <div class="strategy-header">
        <div class="strategy-name">${ind.label}</div>
        <div class="strategy-score">${ind.value}</div>
      </div>
      <div style="text-align:center;margin-top:8px;">
        <span class="badge ${sigClass[ind.signal]}">${ind.signal}</span>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ RENDER PATTERNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPatterns(coin) {
  const ohlc = ohlcData[coin.id] || [];
  const patterns = detectCandlestickPatterns(ohlc);
  
  const list = document.getElementById('patternsList');
  
  if (patterns.length === 0) {
    list.innerHTML = '<div style="color:var(--text-muted);padding:20px;">No patterns detected in recent candles</div>';
    return;
  }
  
  const sigClass = {
    'STRONG BUY': 'badge-strong-buy',
    'BUY': 'badge-buy',
    'SELL': 'badge-sell',
    'STRONG SELL': 'badge-strong-sell',
    'NEUTRAL': 'badge-neutral'
  };
  
  list.innerHTML = patterns.map(p => `
    <div class="pattern-item">
      <div>
        <div class="pattern-name">${p.name}</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">${p.desc}</div>
      </div>
      <span class="badge ${sigClass[p.signal]}">${p.signal}</span>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ RENDER STRATEGIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStrategies(coin) {
  const ohlc = ohlcData[coin.id] || [];
  const closes = ohlc.map(d => d[4]).filter(Boolean);
  
  const strategies = [];
  
  const momentum = calcMomentumStrategy(closes, coin);
  if (momentum) strategies.push(momentum);
  
  const meanRev = calcMeanReversionStrategy(closes, coin);
  if (meanRev) strategies.push(meanRev);
  
  const breakout = calcBreakoutStrategy(ohlc, coin);
  if (breakout) strategies.push(breakout);
  
  const trend = calcTrendFollowingStrategy(closes);
  if (trend) strategies.push(trend);
  
  if (strategies.length === 0) {
    document.getElementById('strategyGrid').innerHTML = '<div style="color:var(--text-muted);padding:20px;">Insufficient data for strategy analysis</div>';
    return;
  }
  
  const sigClass = {
    'STRONG BUY': 'badge-strong-buy',
    'BUY': 'badge-buy',
    'SELL': 'badge-sell',
    'STRONG SELL': 'badge-strong-sell',
    'NEUTRAL': 'badge-neutral'
  };
  
  document.getElementById('strategyGrid').innerHTML = strategies.map(s => {
    const color = s.score >= 70 ? 'var(--green)' : s.score >= 50 ? 'var(--yellow)' : 'var(--red)';
    const details = Object.entries(s).filter(([k]) => !['name', 'score', 'signal', 'desc'].includes(k));
    return `
      <div class="strategy-card">
        <div class="strategy-header">
          <div class="strategy-name">${s.name}</div>
          <div class="strategy-score" style="color:${color}">${s.score}</div>
        </div>
        <div class="strategy-desc">${s.desc}</div>
        ${details.map(([k, v]) => `
          <div class="strategy-detail">
            <div class="detail-label">${k}</div>
            <div class="detail-value">${v}</div>
          </div>`).join('')}
        <div style="text-align:center;margin-top:12px;">
          <span class="badge ${sigClass[s.signal]}">${s.signal}</span>
        </div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ OPPORTUNITY TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateOpportunityTable() {
  const tbody = document.getElementById('oppBody');
  
  const sorted = [...coinsData].map(c => {
    const ohlc = ohlcData[c.id] || [];
    const closes = ohlc.map(d => d[4]).filter(Boolean);
    const score = computeScore(c, closes.length ? ohlc : null);
    const rsi = closes.length >= 15 ? calcRSI(closes) : null;
    const macd = closes.length >= 27 ? calcMACD(closes) : null;
    return { c, score, rsi, macd };
  }).sort((a, b) => b.score.total - a.score.total).slice(0, 15);
  
  tbody.innerHTML = sorted.map(({ c, score, rsi, macd }, i) => {
    const sig = score.total >= 70 ? 'STRONG BUY' : score.total >= 60 ? 'BUY' : score.total <= 30 ? 'STRONG SELL' : score.total <= 40 ? 'SELL' : 'NEUTRAL';
    const sigClass = {
      'STRONG BUY': 'badge-strong-buy',
      'BUY': 'badge-buy',
      'SELL': 'badge-sell',
      'STRONG SELL': 'badge-strong-sell',
      'NEUTRAL': 'badge-neutral'
    };
    const color = score.total >= 70 ? 'var(--green)' : score.total >= 50 ? 'var(--yellow)' : 'var(--red)';
    const change = c.price_change_percentage_24h || 0;
    
    return `<tr onclick="selectCoin('${c.id}')" style="cursor:pointer">
      <td style="color:var(--text-muted);font-family:JetBrains Mono,monospace">${i + 1}</td>
      <td>
        <div style="font-weight:600">${c.symbol.toUpperCase()}</div>
        <div style="font-size:11px;color:var(--text-muted)">${c.name}</div>
      </td>
      <td style="font-family:JetBrains Mono,monospace">${formatUSD(c.current_price)}</td>
      <td style="font-family:JetBrains Mono,monospace;font-weight:700;color:${color}">${score.total}</td>
      <td style="font-family:JetBrains Mono,monospace;color:${change >= 0 ? 'var(--green)' : 'var(--red)'}">${formatPct(change)}</td>
      <td style="font-family:JetBrains Mono,monospace">${rsi ? rsi.toFixed(0) : '‚Äî'}</td>
      <td style="font-family:JetBrains Mono,monospace;color:${macd ? (macd.histogram > 0 ? 'var(--green)' : 'var(--red)') : 'var(--text-muted)'}">${macd ? (macd.histogram > 0 ? '‚ñ≤' : '‚ñº') : '‚Äî'}</td>
      <td><span class="badge ${sigClass[sig]}">${sig}</span></td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ FORMULAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initFormulas() {
  const formulas = [
    {
      title: 'RSI ‚Äî Relative Strength Index',
      eq: 'RS = Avg Gain (14) / Avg Loss (14)\nRSI = 100 - (100 / (1 + RS))',
      desc: 'Momentum oscillator measuring speed of price changes. Overbought >70, Oversold <30.',
      source: 'J. Welles Wilder Jr. "New Concepts in Technical Trading Systems" (1978)'
    },
    {
      title: 'MACD ‚Äî Moving Average Convergence/Divergence',
      eq: 'MACD = EMA(12) - EMA(26)\nSignal = EMA(9) of MACD\nHistogram = MACD - Signal',
      desc: 'Trend-following momentum indicator. Bullish when MACD crosses above signal line.',
      source: 'Gerald Appel "Moving Average Convergence Divergence" (1979)'
    },
    {
      title: 'Bollinger Bands',
      eq: 'Middle = SMA(20)\nUpper = SMA(20) + 2œÉ\nLower = SMA(20) - 2œÉ\n%B = (Price - Lower) / (Upper - Lower)',
      desc: 'Volatility bands. %B > 1 = overbought, %B < 0 = oversold.',
      source: 'John Bollinger "Bollinger on Bollinger Bands" (2002)'
    },
    {
      title: 'Japanese Candlestick Patterns',
      eq: 'Pattern Recognition:\n- Doji: Open ‚âà Close\n- Hammer: Lower wick > 2√ó body\n- Engulfing: Body2 fully engulfs Body1',
      desc: 'Visual patterns indicating market psychology and potential reversals.',
      source: 'Munehisa Homma (17th century), Steve Nison "Japanese Candlestick Charting Techniques" (1991)'
    },
    {
      title: 'Momentum Strategy (Z-Score)',
      eq: 'Z-Score = (Mean_short - Mean_long) / StdDev_long\nSignal: Z > 1.5 = Strong Buy, Z < -1.5 = Strong Sell',
      desc: 'Compares short-term vs long-term returns to identify momentum.',
      source: '<a href="https://medium.com/@briplotnik/systematic-crypto-trading-strategies-momentum-mean-reversion-volatility-filtering-8d7da06d60ed" target="_blank">Briplotnik "Systematic Crypto Trading Strategies" (2025)</a>'
    },
    {
      title: 'Mean Reversion Strategy',
      eq: 'Deviation = ((Price - SMA30) / SMA30) √ó 100\nSignal: Dev < -10 & RSI < 30 = Strong Buy',
      desc: 'Expects prices to return to average. Strong signals at extreme deviations.',
      source: '<a href="https://blog.ueex.com/mean-reversion-strategies-for-profiting-in-cryptocurrency/" target="_blank">UEEx Technology "Mean Reversion Strategies" (2024)</a>, <a href="https://stoic.ai/blog/mean-reversion-trading-how-i-profit-from-crypto-market-overreactions/" target="_blank">Stoic.ai (2025)</a>'
    },
    {
      title: 'Breakout Strategy',
      eq: 'Signal: Price > BB_Upper + High Volume = Strong Buy\nPrice < BB_Lower + High Volume = Strong Sell',
      desc: 'Trades breakouts above/below Bollinger Bands with volume confirmation.',
      source: '<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=5775962" target="_blank">Efe Arda "Bollinger Bands under Varying Market Regimes" SSRN (2025)</a>'
    },
    {
      title: 'Trend Following Strategy',
      eq: 'Signal: Price > SMA20 > SMA50 = Strong Uptrend\nPrice < SMA20 < SMA50 = Strong Downtrend',
      desc: 'Follows trend using simple moving average crossovers.',
      source: '<a href="https://quantpedia.com/trend-following-and-mean-reversion-in-bitcoin/" target="_blank">QuantPedia "Trend-following and Mean-reversion in Bitcoin" (2023, 2025)</a>'
    },
    {
      title: 'Data Sources',
      eq: 'CoinGecko API v3 (Free Tier)\nEndpoints: /coins/markets, /coins/{id}/ohlc, /global\nRate: ~10-15 calls/min (Public), 30 calls/min (Demo)',
      desc: 'All data sourced from CoinGecko free/demo API with rate limiting.',
      source: '<a href="https://docs.coingecko.com/reference/introduction" target="_blank">CoinGecko API Documentation</a>'
    }
  ];
  
  document.getElementById('formulasList').innerHTML = formulas.map(f => `
    <div class="formula-card">
      <div class="formula-title">${f.title}</div>
      <div class="formula-eq">${f.eq}</div>
      <div class="formula-desc">${f.desc}</div>
      <div class="formula-source">Source: ${f.source}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ VERIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function verifyCalcs() {
  const results = [];
  
  results.push({
    name: 'Market Data Loaded',
    pass: coinsData.length > 0,
    detail: `${coinsData.length} coins`
  });
  
  if (coinsData.length > 0) {
    const btc = coinsData.find(c => c.id === 'bitcoin');
    results.push({
      name: 'BTC Price Sanity',
      pass: btc && btc.current_price > 1000,
      detail: btc ? formatUSD(btc.current_price) : 'N/A'
    });
  }
  
  // EMA test
  const testPrices = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
  const ema = calcEMA(testPrices, 5);
  results.push({
    name: 'EMA Algorithm',
    pass: ema.length > 0 && ema[ema.length - 1] > 15 && ema[ema.length - 1] < 22,
    detail: `EMA(5) = ${ema[ema.length - 1]?.toFixed(3)}`
  });
  
  // RSI range
  if (selectedCoin && ohlcData[selectedCoin.id]) {
    const closes = ohlcData[selectedCoin.id].map(d => d[4]).filter(Boolean);
    if (closes.length >= 15) {
      const rsi = calcRSI(closes);
      results.push({
        name: 'RSI Range [0-100]',
        pass: rsi >= 0 && rsi <= 100,
        detail: `RSI = ${rsi.toFixed(2)}`
      });
    }
  }
  
  // Stablecoin filter
  results.push({
    name: 'Stablecoin Exclusion',
    pass: !coinsData.some(c => STABLECOINS.includes(c.id)),
    detail: `${STABLECOINS.length} stables filtered`
  });
  
  // Composite weights
  const weights = [0.25, 0.20, 0.20, 0.15, 0.10, 0.10];
  const sum = weights.reduce((a, b) => a + b, 0);
  results.push({
    name: 'Weight Sum = 1.0',
    pass: Math.abs(sum - 1.0) < 0.001,
    detail: `Sum: ${sum}`
  });
  
  // Candlestick patterns
  if (selectedCoin && ohlcData[selectedCoin.id]) {
    const patterns = detectCandlestickPatterns(ohlcData[selectedCoin.id]);
    results.push({
      name: 'Candlestick Detection',
      pass: true,
      detail: `${patterns.length} patterns found`
    });
  }
  
  // Strategy calculations
  if (selectedCoin && ohlcData[selectedCoin.id]) {
    const closes = ohlcData[selectedCoin.id].map(d => d[4]).filter(Boolean);
    const momentum = calcMomentumStrategy(closes, selectedCoin);
    results.push({
      name: 'Momentum Strategy',
      pass: momentum !== null,
      detail: momentum ? `Score: ${momentum.score}` : 'Insufficient data'
    });
  }
  
  results.push({
    name: 'Data Source',
    pass: true,
    detail: 'CoinGecko API v3 (Free)'
  });
  
  // Render
  const panel = document.getElementById('verifyPanel');
  const passed = results.filter(r => r.pass).length;
  const total = results.length;
  const color = passed === total ? 'var(--green)' : passed > total * 0.7 ? 'var(--yellow)' : 'var(--red)';
  
  panel.innerHTML = `
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;padding:16px;background:var(--bg-elevated);border-radius:8px;">
      <div style="font-size:32px;font-weight:700;font-family:JetBrains Mono,monospace;color:${color}">${passed}/${total}</div>
      <div>
        <div style="font-size:16px;font-weight:600">${passed === total ? 'All Checks Passed ‚úì' : `${passed} of ${total} Checks Passed`}</div>
        <div style="font-size:11px;color:var(--text-muted);font-family:JetBrains Mono,monospace">${new Date().toISOString()}</div>
      </div>
    </div>
    ${results.map(r => `
      <div class="verify-item">
        <div class="verify-icon ${r.pass ? 'pass' : 'fail'}">${r.pass ? '‚úì' : '‚úó'}</div>
        <div class="verify-name">${r.name}</div>
        <div class="verify-detail">${r.detail}</div>
      </div>`).join('')}`;
  
  switchTab('verify');
  toast('Verification complete', 'success');
}

// ‚îÄ‚îÄ‚îÄ EXPORT JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportJSON() {
  if (coinsData.length === 0) {
    toast('Load data first', 'error');
    return;
  }
  
  const data = {
    meta: {
      platform: 'NEXUS Crypto Analysis Platform v2.0',
      generated: new Date().toISOString(),
      data_source: 'CoinGecko API v3 (Free Tier)',
      analysis_mode: document.getElementById('analysisMode').value,
      stablecoins_excluded: STABLECOINS.length
    },
    global_market: globalData,
    opportunities: coinsData.map(c => {
      const ohlc = ohlcData[c.id] || [];
      const closes = ohlc.map(d => d[4]).filter(Boolean);
      const score = computeScore(c, closes.length ? ohlc : null);
      const sig = score.total >= 70 ? 'STRONG_BUY' : score.total >= 60 ? 'BUY' : score.total <= 30 ? 'STRONG_SELL' : score.total <= 40 ? 'SELL' : 'NEUTRAL';
      
      return {
        id: c.id,
        symbol: c.symbol.toUpperCase(),
        name: c.name,
        rank: c.market_cap_rank,
        price_usd: c.current_price,
        market_cap: c.market_cap,
        volume_24h: c.total_volume,
        change_24h: c.price_change_percentage_24h,
        composite_score: score.total,
        signal: sig
      };
    }).sort((a, b) => b.composite_score - a.composite_score)
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nexus-analysis-${Date.now()}.json`;
  a.click();
  toast('JSON exported', 'success');
}

// ‚îÄ‚îÄ‚îÄ UI CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[data-tab="${name}"]`).classList.add('active');
  document.getElementById(name).classList.add('active');
}

function toggleAuto() {
  if (autoRefreshTimer) {
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
    document.getElementById('autoBtn').innerHTML = '<span>‚è±</span> Auto: OFF';
    document.getElementById('autoBtn').classList.remove('active');
    toast('Auto-refresh disabled');
  } else {
    autoRefreshTimer = setInterval(refreshData, 60000);
    document.getElementById('autoBtn').innerHTML = '<span>‚è±</span> Auto: ON (60s)';
    document.getElementById('autoBtn').classList.add('active');
    toast('Auto-refresh enabled', 'success');
  }
}

function handleTopNChange() {
  refreshData();
}

function handleModeChange() {
  if (coinsData.length > 0) {
    renderCoinList();
    if (selectedCoin) {
      const coin = coinsData.find(c => c.id === selectedCoin.id);
      if (coin) renderOverview(coin);
    }
    updateOpportunityTable();
    toast('Analysis mode updated', 'success');
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  initFormulas();
  setStatus('', 'Ready');
});

</script>
</body>
</html>
